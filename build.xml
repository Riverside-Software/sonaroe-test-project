<?xml version="1.0" encoding="utf-8"?>

<!-- How to execute : ant -lib ..\pct\dist\PCT.jar -DDLC=%DLC% -lib %USERPROFILE%\.m2\repository\com\google\guava\guava\19.0\guava-19.0.jar -lib %USERPROFILE%\.m2\repository\org\antlr\antlr4-runtime\4.5.2-1\antlr4-runtime-4.5.2-1.jar clean build sonar -->
<project name="TEST" default="build">
  <taskdef resource="PCT.properties" />

  <!-- Default values for local development instance of SonarQube -->
  <property name="SONAR_URL" value="http://localhost:9000" />
  
  <target name="init">
    <mkdir dir="db" />
    <mkdir dir="build" />
    <mkdir dir="profiler" />
    <mkdir dir="dump" />
    <PCTVersion />
    <ProgressVersion dlcHome="${DLC}" fullVersion="dlc.version.full" />
    <echo message="${dlc.version.full}" />
  </target>

  <target name="clean">
    <delete dir="db" />
    <delete dir="build" />
    <delete dir="profiler" />
    <delete dir="dump" />
  </target>

  <target name="db" depends="init">
    <sports2000 destDir="db" dbName="sp2k" dlcHome="${DLC}" />
    <PCTDumpSchema destFile="dump/sp2k.df" dlcHome="${DLC}">
      <DBConnection dbName="sp2k" dbDir="db" singleUser="true" />
    </PCTDumpSchema>
    <echo file="dump/empty.df" />
  </target>

  <target name="build" depends="db">
    <PCTCompile destdir="build" dlcHome="${DLC}" cpinternal="utf-8" cpstream="utf-8" listing="true" debugListing="true" flattenDebugListing="false" relativePaths="true" xmlXref="true" keepXref="true">
      <fileset dir="src/classes" includes="**/*.cls" />
      <fileset dir="src/procedures" includes="**/*.p" />
      <propath>
        <pathelement location="src/classes" />
        <pathelement location="src/procedures" />
      </propath>
      <PCTConnection dbName="sp2k" dbDir="db" singleUser="true" logicalName="abc">
        <Alias name="sp2k" />
        <Alias name="foobar" />
      </PCTConnection>
    </PCTCompile>

    <!-- Unit tests -->
    <PCTRun procedure="sample/test3.p" dlcHome="${DLC}">
      <propath location="build" />
      <Profiler enabled="true" outputDir="profiler" coverage="true" />
      <PCTConnection dbName="sp2k" dbDir="db" singleUser="true" logicalName="abc">
        <PCTAlias name="sp2k" />
        <PCTAlias name="foobar" />
      </PCTConnection>
    </PCTRun>
    <PCTRun procedure="sample/test5.p" dlcHome="${DLC}">
      <propath location="build" />
      <Profiler enabled="true" outputDir="profiler" coverage="true" />
      <PCTConnection dbName="sp2k" dbDir="db" singleUser="true" logicalName="abc">
        <PCTAlias name="sp2k" />
        <PCTAlias name="foobar" />
      </PCTConnection>
    </PCTRun>
    <PCTRun procedure="sample/test6.p" dlcHome="${DLC}">
      <propath location="build" />
      <Profiler enabled="true" outputDir="profiler" coverage="true" />
      <PCTConnection dbName="sp2k" dbDir="db" singleUser="true" logicalName="abc">
        <PCTAlias name="sp2k" />
        <PCTAlias name="foobar" />
      </PCTConnection>
    </PCTRun>
  </target>

  <target name="dist">
    <mkdir dir="dist" />
    <copy todir="dist">
      <fileset dir="build" includes="**/*.r" />
      <fileset dir="build/.dbg" includes="*.w,*.p,*.cls" />
    </copy>
  </target>

  <target name="sonar" >
    <java classname="org.sonarsource.scanner.cli.Main" fork="true" failOnError="true">
      <jvmarg value="-Drunner.home=." />
      <jvmarg value="-Dproject.home=." />
      <jvmarg value="-Dproject.settings=sonar-project1.properties" />
      <jvmarg value="-Dsonar.projectVersion=1.0" />
      <jvmarg value="-Dsonar.verbose=false" />
      <jvmarg value="-Dsonar.host.url=${SONAR_URL}" />
      <jvmarg value="-Dsonar.oe.dlc=${DLC}" />
      <classpath location="sonar-scanner-cli-2.5.1.jar" />
    </java>
  </target>

</project>
